<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= video ? video.title : 'Video' %> - <%= courseName %></title>
    <%- include('partials/interactive-styles') %>
    <%- include('partials/video-styles') %>
    <%- include('partials/chatbot-styles') %>
    <style>
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        .corner-badges {
            position: fixed;
            top: 80px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        
        .corner-badge {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            min-width: 200px;
            transition: all 0.2s ease;
        }
        
        .dark .corner-badge {
            background: rgba(28, 28, 30, 0.9);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
        }
        
        .corner-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .badge-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .badge-icon {
            font-size: 20px;
        }
        
        .badge-stats {
            flex: 1;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .stat-row:last-child {
            margin-bottom: 0;
        }
        
        .stat-row .stat-label {
            font-size: 11px;
            color: #86868b;
            font-weight: 500;
        }
        
        .stat-row .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .dark .stat-row .stat-value {
            color: #f5f5f7;
        }
        
        .dark #keyTopics h4 {
            color: #f5f5f7;
        }
        
        .dark .sidebar-card {
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .dark #refreshTodos {
            background: #2c2c2e;
            color: #f5f5f7;
        }
        
        .dark #refreshTodos:hover {
            background: #3a3a3c;
        }
        
        .dark .loading-skeleton .skeleton-line {
            background: linear-gradient(90deg, #2c2c2e 25%, #3a3a3c 50%, #2c2c2e 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        .dark .loading-spinner {
            border-color: #2c2c2e !important;
            border-top-color: #007aff !important;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: #86868b;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        .shortcuts-mini {
            flex: 1;
        }
        
        .shortcut-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .shortcut-row:last-child {
            margin-bottom: 0;
        }
        
        .shortcut-row span {
            background: #f2f2f7;
            color: #1d1d1f;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 500;
            min-width: 16px;
            text-align: center;
        }
        
        .dark .shortcut-row span {
            background: #2c2c2e;
            color: #f5f5f7;
        }
        
        .chapters-sidebar {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .corner-badges {
                position: relative;
                top: auto;
                left: auto;
                flex-direction: row;
                justify-content: center;
                margin: 20px 0;
            }
            
            .corner-badge {
                min-width: auto;
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">üåô</button>
    
    <div class="container">
        <%- include('partials/video-header', { video, courseName }) %>

        <% if (video) { %>
        <div class="main-content">
            <div class="video-main">
                <%- include('partials/video-player', { video, courseName, isYouTube }) %>

                
                <%- include('partials/video-controls', { video, courseName, isFirstVideo, isLastVideo, watchedVideos, totalVideos, watchedPercent }) %>
                
                <!-- Video Summary & AI Section -->
                <div class="sidebar-card" style="margin-top: 24px;">
                    <div style="display: grid; gap: 24px;">
                        <!-- Video Summary -->
                        <div>
                            <h3 class="sidebar-title">üìù Video Summary</h3>
                            <div id="videoSummary" style="font-size: 14px; line-height: 1.5; color: #86868b; margin-bottom: 16px; max-height: 128px; overflow-y: auto;">
                                <div class="loading-skeleton">
                                    <div class="skeleton-line"></div>
                                    <div class="skeleton-line short"></div>
                                </div>
                            </div>
                            <div id="keyTopics">
                                <h4 style="font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">üîë Key Topics:</h4>
                                <div id="topicsList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                            </div>
                        </div>
                        
                        <!-- AI Todos -->
                        <div style="border-top: 1px solid #f2f2f7; padding-top: 24px;">
                            <h3 class="sidebar-title">ü§ñ AI Todos</h3>
                            <div id="todoContainer" style="max-height: 200px; overflow-y: auto; margin-bottom: 16px;">
                                <div id="todoLoading" style="text-align: center; padding: 16px 0; font-size: 14px; color: #86868b;">
                                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                                        <div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid #f2f2f7; border-top: 2px solid #007aff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                                        <span>AI analyzing content...</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span id="todoProgress" style="font-size: 12px; color: #86868b;">0/0 completed</span>
                                <button id="refreshTodos" style="font-size: 11px; padding: 4px 8px; background: #f2f2f7; color: #1d1d1f; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div style="width: 100%; height: 6px; background: #f2f2f7; border-radius: 3px; overflow: hidden;">
                                <div id="todoProgressBar" style="height: 100%; background: #30d158; border-radius: 3px; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chapters Sidebar -->
            <% if (typeof chapters !== 'undefined' && chapters.length > 0) { %>
            <div class="chapters-sidebar">
                <div class="sidebar-card">
                    <h3 class="sidebar-title">üìö Chapters</h3>
                    <div class="chapter-list">
                        <% chapters.sort((a, b) => {
                            const aMatch = a.match(/(\d+)/);
                            const bMatch = b.match(/(\d+)/);
                            if (!aMatch || !bMatch) return a.localeCompare(b);
                            return parseInt(aMatch[0], 10) - parseInt(bMatch[0], 10);
                        }).forEach(chapter => {
                            const chapterVideos = videosByChapter[chapter];
                        %>
                        <div class="chapter-item interactive-chapter">
                            <strong><%= chapter %></strong>
                            <% chapterVideos.forEach((chapterVideo, index) => { %>
                            <div style="margin-left: 12px; margin-top: 4px;">
                                <a href="/videos/<%= encodeURIComponent(courseName) %>/<%= chapterVideo._id %>" 
                                   class="chapter-link interactive-link <%= chapterVideo._id.toString() === video._id.toString() ? 'active' : '' %>">
                                    <%= (index + 1) %>. <%= chapterVideo.title %>
                                    <% if (chapterVideo.watched) { %> ‚úì<% } %>
                                </a>
                            </div>
                            <% }); %>
                        </div>
                        <% }); %>
                    </div>
                </div>
            </div>
            <% } %>
        </div>
        
        <!-- Corner Badges -->
        <div class="corner-badges">
            <!-- Progress Badge -->
            <div class="corner-badge progress-badge">
                <div class="badge-content">
                    <span class="badge-icon">üìä</span>
                    <div class="badge-stats">
                        <div class="stat-row">
                            <span class="stat-label">Level</span>
                            <span class="stat-value user-level">1</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Points</span>
                            <span class="stat-value user-points">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Streak</span>
                            <span class="stat-value user-streak">0üî•</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shortcuts Badge -->
            <div class="corner-badge shortcuts-badge">
                <div class="badge-content">
                    <span class="badge-icon">‚å®Ô∏è</span>
                    <div class="shortcuts-mini">
                        <div class="shortcut-row"><span>F</span>Fullscreen</div>
                        <div class="shortcut-row"><span>K</span>Play/Pause</div>
                        <div class="shortcut-row"><span>J</span>-10s</div>
                        <div class="shortcut-row"><span>L</span>+10s</div>
                    </div>
                </div>
            </div>
        </div>
        <% } else { %>
        <div class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 class="error-title">Video Not Found</h2>
            <p class="error-message">The requested video could not be loaded.</p>
            <a href="/course/<%= courseName %>" class="btn btn-primary">
                <span>‚Üê</span> Back to Course
            </a>
        </div>
        <% } %>
    </div>

    <div id="keyHint" class="key-hint"></div>
    
    <%- include('partials/achievement-popup') %>
    <%- include('partials/floating-chatbot') %>

    <link rel="stylesheet" href="/css/quiz-system.css">
    <script src="/js/confetti.min.js"></script>
    <script src="/js/gamification.js"></script>
    <script src="/js/quiz-system.js"></script>
    <%- include('partials/video-scripts', { video, courseName, isLastVideo, isLastInChapter }) %>
    <script>
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('themeToggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.classList.toggle('dark', newTheme === 'dark');
            localStorage.setItem('theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        initTheme();
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        document.addEventListener('DOMContentLoaded', function() {
            const videoPlayer = document.getElementById('videoPlayer');
            const markWatchedButton = document.getElementById('markWatchedButton');
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const keyHint = document.getElementById('keyHint');
            
            let courseName = '<%= courseName %>';
            let videoId = '<%= video ? video._id : "" %>';
            
            function showKeyHint(text) {
                if (keyHint) {
                    keyHint.textContent = text;
                    keyHint.classList.add('visible');
                    setTimeout(() => keyHint.classList.remove('visible'), 1000);
                }
            }

            function markVideoAsWatched() {
                fetch(`/api/videos/${encodeURIComponent(courseName)}/${videoId}/watch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.status-badge');
                    if (badge) {
                        badge.className = 'status-badge status-watched';
                        badge.innerHTML = '‚úì Watched';
                    }
                    
                    updateVideoCount();
                    
                    if (window.gamificationSystem) {
                        window.gamificationSystem.onVideoCompleted({
                            videoId, courseName,
                            isLastVideo: <%= isLastVideo ? 'true' : 'false' %>,
                            isLastInChapter: <%= isLastInChapter ? 'true' : 'false' %>
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
            }

            // Event listeners
            if (markWatchedButton) {
                markWatchedButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Mark watched button clicked');
                    markVideoAsWatched();
                });
            } else {
                console.log('Mark watched button not found');
            }
            
            if (prevButton) {
                prevButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('Previous button clicked');
                    try {
                        const response = await fetch(`/api/next-video?currentVideoId=${videoId}&courseName=${encodeURIComponent(courseName)}&direction=prev`);
                        if (response.ok) {
                            const prevVideo = await response.json();
                            console.log('Previous video:', prevVideo);
                            window.location.href = `/videos/${encodeURIComponent(courseName)}/${prevVideo._id}`;
                        } else {
                            console.error('No previous video found');
                        }
                    } catch (error) {
                        console.error('Error getting previous video:', error);
                    }
                });
            } else {
                console.log('Previous button not found');
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`/api/next-video?currentVideoId=${videoId}&courseName=${encodeURIComponent(courseName)}&direction=next`);
                        if (response.ok) {
                            const nextVideo = await response.json();
                            window.location.href = `/videos/${encodeURIComponent(courseName)}/${nextVideo._id}?autoplay=true`;
                        }
                    } catch (error) {
                        console.error('Error getting next video:', error);
                    }
                });
            }

            // Award points for keyboard shortcuts
            async function awardKeyboardPoints(action) {
                try {
                    const response = await fetch('/api/gamification/keyboard-shortcut', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    const data = await response.json();
                    if (data.success && window.gamificationSystem) {
                        window.gamificationSystem.updateStats({
                            totalPoints: data.points,
                            level: data.level
                        });
                    }
                } catch (error) {
                    console.error('Error awarding keyboard points:', error);
                }
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (!videoPlayer || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;

                const key = e.key.toLowerCase();
                
                switch(key) {
                    case 'f':
                        e.preventDefault();
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                            showKeyHint('Exit Fullscreen');
                        } else {
                            videoPlayer.requestFullscreen();
                            showKeyHint('Fullscreen');
                        }
                        awardKeyboardPoints('fullscreen');
                        break;
                    case 'j':
                        e.preventDefault();
                        if (videoPlayer.currentTime) {
                            videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
                            showKeyHint('‚è™ -10s');
                        }
                        awardKeyboardPoints('seek_backward');
                        break;
                    case 'k':
                    case ' ':
                        e.preventDefault();
                        if (videoPlayer.paused) {
                            videoPlayer.play();
                            showKeyHint('‚ñ∂Ô∏è Play');
                        } else {
                            videoPlayer.pause();
                            showKeyHint('‚è∏Ô∏è Pause');
                        }
                        awardKeyboardPoints('play_pause');
                        break;
                    case 'l':
                        e.preventDefault();
                        if (videoPlayer.duration) {
                            videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
                            showKeyHint('‚è© +10s');
                        }
                        awardKeyboardPoints('seek_forward');
                        break;
                }
            });

            // Video event listeners
            if (videoPlayer) {
                videoPlayer.addEventListener('ended', markVideoAsWatched);
                
                let watchedMarked = false;
                videoPlayer.addEventListener('timeupdate', function() {
                    if (!videoPlayer.duration) return;
                    const watchPercent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                    
                    if (watchPercent >= 90 && !watchedMarked) {
                        markVideoAsWatched();
                        watchedMarked = true;
                    }
                });
            }

            // Floating Chatbot Functions
            window.showFloatingChatbot = function() {
                const chatbot = document.getElementById('floating-chatbot');
                const trigger = document.getElementById('chatbot-trigger');
                
                if (chatbot) {
                    chatbot.style.display = 'flex';
                }
                if (trigger) {
                    trigger.style.display = 'none';
                }
                
                setTimeout(() => {
                    const input = document.getElementById('floating-chat-input');
                    if (input) input.focus();
                }, 300);
            };
            
            window.toggleFloatingChatbot = function() {
                const chatbot = document.getElementById('floating-chatbot');
                const trigger = document.getElementById('chatbot-trigger');
                
                if (chatbot) {
                    chatbot.style.display = 'none';
                }
                if (trigger) {
                    trigger.style.display = 'flex';
                }
            };

            window.sendFloatingChatMessage = async function() {
                const input = document.getElementById('floating-chat-input');
                const messages = document.getElementById('floating-chat-messages');
                
                if (!input || !messages) return;
                
                const message = input.value.trim();
                if (!message) return;
                
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                messages.innerHTML += `
                    <div class="chat-message user">
                        <div class="message-content">${message}</div>
                        <div class="message-meta">You ‚Ä¢ ${time}</div>
                    </div>
                `;
                
                input.value = '';
                messages.scrollTop = messages.scrollHeight;
                
                // Add typing indicator
                const typingId = 'typing-' + Date.now();
                messages.innerHTML += `
                    <div class="chat-message bot" id="${typingId}">
                        <div class="message-content">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                        <div class="message-meta">Nova Pro ‚Ä¢ typing...</div>
                    </div>
                `;
                messages.scrollTop = messages.scrollHeight;
                
                try {
                    const response = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message, 
                            aiModel: 'nova-pro',
                            context: {
                                videoTitle: '<%= video ? video.title : "" %>',
                                courseName: courseName,
                                videoId: videoId
                            }
                        })
                    });
                    
                    const data = await response.json();
                    const botTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Remove typing indicator
                    document.getElementById(typingId)?.remove();
                    
                    if (data.success) {
                        // Parse markdown-like formatting
                        let formattedResponse = data.response
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            .replace(/`(.*?)`/g, '<code style="background: #f2f2f7; padding: 2px 4px; border-radius: 4px; font-family: SF Mono, Monaco, monospace;">$1</code>')
                            .replace(/```([\s\S]*?)```/g, '<pre style="background: #f2f2f7; padding: 12px; border-radius: 8px; overflow-x: auto; font-family: SF Mono, Monaco, monospace; margin: 8px 0;"><code>$1</code></pre>')
                            .replace(/\n/g, '<br>');
                        
                        messages.innerHTML += `
                            <div class="chat-message bot">
                                <div class="message-content">${formattedResponse}</div>
                                <div class="message-meta">
                                    <span>ü§ñ Nova Pro ‚Ä¢ ${botTime}</span>
                                    <button onclick="copyMessage(this)" style="margin-left: 8px; padding: 2px 6px; background: #f2f2f7; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">üìã</button>
                                </div>
                            </div>
                        `;
                    } else {
                        messages.innerHTML += `
                            <div class="chat-message bot">
                                <div class="message-content">Sorry, I couldn't process that.</div>
                                <div class="message-meta">ü§ñ Nova Pro ‚Ä¢ ${botTime}</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Remove typing indicator on error
                    document.getElementById(typingId)?.remove();
                    
                    const botTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    messages.innerHTML += `
                        <div class="chat-message bot">
                            <div class="message-content">Connection error. Please try again.</div>
                            <div class="message-meta">ü§ñ Nova Pro ‚Ä¢ ${botTime}</div>
                        </div>
                    `;
                }
                
                messages.scrollTop = messages.scrollHeight;
            };

            // Enter key for chat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && document.activeElement && document.activeElement.id === 'floating-chat-input') {
                    e.preventDefault();
                    sendFloatingChatMessage();
                }
            });

            // Quiz function
            window.startVideoQuiz = async function() {
                try {
                    const response = await fetch(`/api/quizzes/${videoId}`);
                    const data = await response.json();
                    
                    if (data.success && data.quiz && window.quizSystem) {
                        window.quizSystem.startQuiz('video-specific', data.quiz);
                    } else if (window.quizSystem) {
                        window.quizSystem.startQuiz('terraform');
                    }
                } catch (error) {
                    console.error('Error loading quiz:', error);
                }
            };

            // SRT Generation
            const generateSRTButton = document.getElementById('generateSRTButton');
            if (generateSRTButton) {
                generateSRTButton.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Generate SRT button clicked');
                    this.disabled = true;
                    this.innerHTML = '<span>‚è≥</span> Generating...';
                    
                    try {
                        const response = await fetch('/api/generate-srt', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                videoTitle: '<%= video ? video.title : "" %>',
                                courseName,
                                videoId
                            })
                        });
                        
                        const data = await response.json();
                        if (data.status === 'processing') {
                            this.innerHTML = '<span>üîÑ</span> Processing...';
                        } else {
                            this.innerHTML = '<span>‚úÖ</span> Ready';
                            this.disabled = false;
                        }
                    } catch (error) {
                        console.error('SRT generation failed:', error);
                        this.innerHTML = '<span>‚ùå</span> Failed';
                        this.disabled = false;
                    }
                });
            } else {
                console.log('Generate SRT button not found');
            }

            // Fetch and update video count
            async function updateVideoCount() {
                try {
                    const response = await fetch(`/api/videos/course/${encodeURIComponent(courseName)}/count`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const progressText = document.getElementById('videoProgress');
                        if (progressText) {
                            progressText.textContent = `${data.data.watched}/${data.data.total} videos`;
                        }
                        
                        const progressFill = document.querySelector('.progress-fill');
                        if (progressFill && data.data.total > 0) {
                            const percentage = Math.round((data.data.watched / data.data.total) * 100);
                            progressFill.style.width = `${percentage}%`;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching video count:', error);
                }
            }
            
            // Copy message function
            window.copyMessage = function(button) {
                const messageContent = button.closest('.chat-message').querySelector('.message-content').innerText;
                navigator.clipboard.writeText(messageContent).then(() => {
                    button.textContent = '‚úì';
                    setTimeout(() => button.textContent = 'üìã', 1000);
                });
            };
            
            // Load cached todos from DynamoDB
            async function loadCachedTodos() {
                try {
                    const videoTitle = '<%= video ? video.title : "" %>';
                    const response = await fetch(`/api/todos/${encodeURIComponent(videoTitle)}`);
                    const data = await response.json();
                    
                    if (data.success && data.todos.length > 0) {
                        const todoContainer = document.getElementById('todo-container');
                        if (todoContainer) {
                            renderCachedTodos(data.todos);
                        }
                    }
                } catch (error) {
                    console.error('Error loading cached todos:', error);
                }
            }
            
            function renderCachedTodos(todos) {
                const todoContainer = document.getElementById('todo-container');
                if (!todoContainer) return;
                
                let html = '';
                todos.forEach((todo, index) => {
                    html += `
                        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.5); border-radius: 12px; border: 1px solid #f2f2f7;">
                            <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleCachedTodo('${todo.id}', this.checked)" style="margin-top: 2px; accent-color: #007aff;">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500; color: #1d1d1f; margin-bottom: 4px;">${todo.task}</div>
                                <div style="font-size: 11px; color: #86868b;">${todo.completed && todo.completedAt ? 'Completed: ' + new Date(todo.completedAt).toLocaleDateString() : 'From SRT analysis'}</div>
                            </div>
                        </div>
                    `;
                });
                
                todoContainer.innerHTML = html;
                
                // Update progress
                const completed = todos.filter(t => t.completed).length;
                const total = todos.length;
                const progressText = document.getElementById('todo-progress');
                const progressBar = document.getElementById('todo-progress-bar');
                
                if (progressText) {
                    progressText.textContent = `${completed}/${total} completed`;
                }
                if (progressBar && total > 0) {
                    const percentage = Math.round((completed / total) * 100);
                    progressBar.style.width = `${percentage}%`;
                }
            }
            
            window.toggleCachedTodo = function(todoId, completed) {
                // Update local state and sync to backend if needed
                console.log('Todo toggled:', todoId, completed);
            };
            
            // Update count and load todos on page load
            updateVideoCount();
            loadCachedTodos();
        });
    </script>
</body>
</html>